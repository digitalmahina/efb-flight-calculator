#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ç–∫–∏ hotfix
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/git-workflow/new-hotfix.sh "–æ–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ $# -eq 0 ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 \"–æ–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è\""
    echo "–ü—Ä–∏–º–µ—Ä: $0 \"security-patch\""
    exit 1
fi

HOTFIX_DESC="$1"
HOTFIX_BRANCH="hotfix/$HOTFIX_DESC"

echo -e "${BLUE}üö® –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ hotfix: $HOTFIX_BRANCH${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è${NC}"
    echo "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º hotfix"
    exit 1
fi

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main
echo -e "${YELLOW}üìã –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É main...${NC}"
if ! git checkout main; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ main${NC}"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º main
echo -e "${YELLOW}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ main...${NC}"
if ! git pull origin main; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ origin/main${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Ç–∫–∞ hotfix –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git show-ref --verify --quiet refs/heads/$HOTFIX_BRANCH; then
    echo -e "${RED}‚ùå –í–µ—Ç–∫–∞ $HOTFIX_BRANCH —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
    echo "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤–µ—Ç–∫—É? (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        git checkout $HOTFIX_BRANCH
        echo -e "${GREEN}‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–µ—Ç–∫—É $HOTFIX_BRANCH${NC}"
    else
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
else
    # –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É hotfix
    echo -e "${YELLOW}üåø –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ $HOTFIX_BRANCH...${NC}"
    git checkout -b $HOTFIX_BRANCH
    echo -e "${GREEN}‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ç–∫–∞ $HOTFIX_BRANCH${NC}"
fi

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º hotfix
HOTFIX_DESC_FILE="HOTFIX_$HOTFIX_DESC.md"
cat > "$HOTFIX_DESC_FILE" << EOF
# Hotfix: $HOTFIX_DESC

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–û–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–µ–π –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

## üîç –ü—Ä–æ–±–ª–µ–º–∞
- **–¢–∏–ø**: Security/Bug/Performance
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: Critical/High/Medium
- **–í–ª–∏—è–Ω–∏–µ**: –û–ø–∏—Å–∞–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ**: –®–∞–≥–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

## üîß –†–µ—à–µ–Ω–∏–µ
- [ ] –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
- [ ] –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit —Ç–µ—Å—Ç—ã
- [ ] Integration —Ç–µ—Å—Ç—ã
- [ ] Manual —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Regression —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Security —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìã –ß–µ–∫-–ª–∏—Å—Ç
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
- [ ] –ù–µ –Ω–∞—Ä—É—à–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω—ã –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- [ ] –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
- [ ] –ü–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## üìä –ú–µ—Ç—Ä–∏–∫–∏
- [ ] –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ issues
- #issue1
- #issue2
- #issue3

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.
EOF

echo -e "${GREEN}üìù –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –æ–ø–∏—Å–∞–Ω–∏—è hotfix: $HOTFIX_DESC_FILE${NC}"

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ package.json (patch –≤–µ—Ä—Å–∏—è)
if [ -f "package.json" ]; then
    echo -e "${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ patch –≤–µ—Ä—Å–∏–∏ –≤ package.json...${NC}"
    if command -v jq &> /dev/null; then
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
        CURRENT_VERSION=$(jq -r '.version' package.json)
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º patch –≤–µ—Ä—Å–∏—é
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$3++; print $1"."$2"."$3}')
        jq ".version = \"$NEW_VERSION\"" package.json > package.json.tmp && mv package.json.tmp package.json
        echo -e "${GREEN}‚úÖ –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å $CURRENT_VERSION –Ω–∞ $NEW_VERSION${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  jq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –æ–±–Ω–æ–≤–∏—Ç–µ –≤–µ—Ä—Å–∏—é –≤—Ä—É—á–Ω—É—é${NC}"
    fi
fi

# –°–æ–∑–¥–∞–µ–º CHANGELOG –∑–∞–ø–∏—Å—å
if [ -f "CHANGELOG.md" ]; then
    echo -e "${YELLOW}üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG...${NC}"
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
    cat > CHANGELOG_NEW.md << EOF
## [Unreleased] - Hotfix

### Fixed
- $HOTFIX_DESC

EOF
    cat CHANGELOG.md >> CHANGELOG_NEW.md
    mv CHANGELOG_NEW.md CHANGELOG.md
    echo -e "${GREEN}‚úÖ CHANGELOG –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ Git
git add .
git commit -m "chore(hotfix): –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è $HOTFIX_DESC"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Ç–∫—É
echo -e "${YELLOW}üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—Ç–∫–∏ hotfix...${NC}"
if ! git push -u origin $HOTFIX_BRANCH; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–µ—Ç–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º...${NC}"
    git push origin $HOTFIX_BRANCH
fi

echo ""
echo -e "${GREEN}üéâ –í–µ—Ç–∫–∞ hotfix $HOTFIX_BRANCH —Å–æ–∑–¥–∞–Ω–∞!${NC}"
echo -e "${BLUE}üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É"
echo "2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
echo "3. –°–æ–∑–¥–∞–π—Ç–µ Pull Request: main ‚Üê $HOTFIX_BRANCH"
echo "4. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Å–ª–µ–π—Ç–µ –≤ main"
echo "5. –°–ª–µ–π—Ç–µ —Ç–∞–∫–∂–µ –≤ develop"
echo "6. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–≥: git tag -a v1.1.1 -m 'Hotfix v1.1.1'"
echo "7. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–≥: git push origin v1.1.1"
echo ""
echo -e "${YELLOW}üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo "  git status                    - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "  git log --oneline -5         - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã"
echo "  git diff main                - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  git checkout main             - –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ main"
echo ""
echo -e "${RED}‚ö†Ô∏è  –í–ê–ñ–ù–û: Hotfix —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è!${NC}"
echo -e "${BLUE}üîó –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PR:${NC}"
echo "https://github.com/digitalmahina/efb-flight-calculator/compare/$HOTFIX_BRANCH"
