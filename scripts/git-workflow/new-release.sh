#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ç–∫–∏ —Ä–µ–ª–∏–∑–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/git-workflow/new-release.sh v1.1.0

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ $# -eq 0 ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 v1.1.0"
    echo "–ü—Ä–∏–º–µ—Ä: $0 v1.1.0"
    exit 1
fi

VERSION="$1"
RELEASE_BRANCH="release/$VERSION"

echo -e "${BLUE}üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ —Ä–µ–ª–∏–∑–∞: $RELEASE_BRANCH${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è${NC}"
    echo "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–ª–∏–∑–∞"
    exit 1
fi

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ develop
echo -e "${YELLOW}üìã –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É develop...${NC}"
if ! git checkout develop; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ develop${NC}"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º develop
echo -e "${YELLOW}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ develop...${NC}"
if ! git pull origin develop; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ origin/develop${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Ç–∫–∞ —Ä–µ–ª–∏–∑–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git show-ref --verify --quiet refs/heads/$RELEASE_BRANCH; then
    echo -e "${RED}‚ùå –í–µ—Ç–∫–∞ $RELEASE_BRANCH —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
    echo "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤–µ—Ç–∫—É? (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        git checkout $RELEASE_BRANCH
        echo -e "${GREEN}‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–µ—Ç–∫—É $RELEASE_BRANCH${NC}"
    else
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
else
    # –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
    echo -e "${YELLOW}üåø –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ $RELEASE_BRANCH...${NC}"
    git checkout -b $RELEASE_BRANCH
    echo -e "${GREEN}‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ç–∫–∞ $RELEASE_BRANCH${NC}"
fi

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ä–µ–ª–∏–∑–∞
RELEASE_DESC_FILE="RELEASE_$VERSION.md"
cat > "$RELEASE_DESC_FILE" << EOF
# Release $VERSION

## üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–ª–∏–∑–µ $VERSION.

## üöÄ –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –§—É–Ω–∫—Ü–∏—è 1
- [ ] –§—É–Ω–∫—Ü–∏—è 2
- [ ] –§—É–Ω–∫—Ü–∏—è 3

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3

## üîß –£–ª—É—á—à–µ–Ω–∏—è
- [ ] –£–ª—É—á—à–µ–Ω–∏–µ 1
- [ ] –£–ª—É—á—à–µ–Ω–∏–µ 2
- [ ] –£–ª—É—á—à–µ–Ω–∏–µ 3

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Integration —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Manual —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- [ ] Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Security —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω README
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω CHANGELOG
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìä –ú–µ—Ç—Ä–∏–∫–∏
- [ ] –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ issues
- #issue1
- #issue2
- #issue3
EOF

echo -e "${GREEN}üìù –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞: $RELEASE_DESC_FILE${NC}"

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ package.json (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -f "package.json" ]; then
    echo -e "${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –≤ package.json...${NC}"
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
    if command -v jq &> /dev/null; then
        # –ï—Å–ª–∏ jq –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        jq ".version = \"$VERSION\"" package.json > package.json.tmp && mv package.json.tmp package.json
    else
        # –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —á–µ—Ä–µ–∑ sed
        sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
        rm -f package.json.bak
    fi
    echo -e "${GREEN}‚úÖ –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ package.json${NC}"
fi

# –°–æ–∑–¥–∞–µ–º CHANGELOG –∑–∞–ø–∏—Å—å
if [ -f "CHANGELOG.md" ]; then
    echo -e "${YELLOW}üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG...${NC}"
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
    cat > CHANGELOG_NEW.md << EOF
## [$VERSION] - $(date +%Y-%m-%d)

### Added
- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–ª–∏–∑–∞

### Changed
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

### Fixed
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

### Security
- –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

EOF
    cat CHANGELOG.md >> CHANGELOG_NEW.md
    mv CHANGELOG_NEW.md CHANGELOG.md
    echo -e "${GREEN}‚úÖ CHANGELOG –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ Git
git add .
git commit -m "chore(release): –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–ª–∏–∑–∞ $VERSION"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Ç–∫—É
echo -e "${YELLOW}üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—Ç–∫–∏ —Ä–µ–ª–∏–∑–∞...${NC}"
if ! git push -u origin $RELEASE_BRANCH; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–µ—Ç–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º...${NC}"
    git push origin $RELEASE_BRANCH
fi

echo ""
echo -e "${GREEN}üéâ –í–µ—Ç–∫–∞ —Ä–µ–ª–∏–∑–∞ $RELEASE_BRANCH —Å–æ–∑–¥–∞–Ω–∞!${NC}"
echo -e "${BLUE}üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "1. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo "2. –û–±–Ω–æ–≤–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"
echo "3. –°–æ–∑–¥–∞–π—Ç–µ Pull Request: develop ‚Üê $RELEASE_BRANCH"
echo "4. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Å–ª–µ–π—Ç–µ –≤ main"
echo "5. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–≥: git tag -a $VERSION -m 'Release $VERSION'"
echo "6. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–≥: git push origin $VERSION"
echo ""
echo -e "${YELLOW}üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo "  git status                    - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "  git log --oneline -5         - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã"
echo "  git diff develop            - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  git checkout develop         - –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ develop"
echo ""
echo -e "${BLUE}üîó –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PR:${NC}"
echo "https://github.com/digitalmahina/efb-flight-calculator/compare/$RELEASE_BRANCH"
